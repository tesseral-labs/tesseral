syntax = "proto3";

package openauth.intermediate.v1;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

service IntermediateService {
  rpc ListSAMLOrganizations(ListSAMLOrganizationsRequest) returns (ListSAMLOrganizationsResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/saml-organizations",
      body: "*"
    };
  }

  rpc GetSettings(GetSettingsRequest) returns (GetSettingsResponse);

  rpc RedeemUserImpersonationToken(RedeemUserImpersonationTokenRequest) returns (RedeemUserImpersonationTokenResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/redeem-user-impersonation-token",
      body: "*"
    };
  }

  rpc CreateIntermediateSession(CreateIntermediateSessionRequest) returns (CreateIntermediateSessionResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/intermediate-session",
      body: "*"
    };
  }

  rpc Whoami(WhoamiRequest) returns (WhoamiResponse) {
    option (google.api.http) = {
      get: "/intermediate/v1/whoami"
    };
  }

  rpc CreateOrganization(CreateOrganizationRequest) returns (CreateOrganizationResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/organizations",
      body: "*"
    };
  }

  rpc ListOrganizations(ListOrganizationsRequest) returns (ListOrganizationsResponse) {
    option (google.api.http) = {
      get: "/intermediate/v1/organizations"
    };
  }

  rpc SetOrganization(SetOrganizationRequest) returns (SetOrganizationResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/set-organization",
    };
  }

  rpc ExchangeIntermediateSessionForSession(ExchangeIntermediateSessionForSessionRequest) returns (ExchangeIntermediateSessionForSessionResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/exchange-intermediate-session-for-session",
      body: "*"
    };
  }

  rpc GetGoogleOAuthRedirectURL(GetGoogleOAuthRedirectURLRequest) returns (GetGoogleOAuthRedirectURLResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/google-oauth-redirect-url",
      body: "*"
    };
  }

  rpc RedeemGoogleOAuthCode(RedeemGoogleOAuthCodeRequest) returns (RedeemGoogleOAuthCodeResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/redeem-google-oauth-code",
      body: "*"
    };
  }

  rpc GetMicrosoftOAuthRedirectURL(GetMicrosoftOAuthRedirectURLRequest) returns (GetMicrosoftOAuthRedirectURLResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/microsoft-oauth-redirect-url",
      body: "*"
    };
  }

  rpc RedeemMicrosoftOAuthCode(RedeemMicrosoftOAuthCodeRequest) returns (RedeemMicrosoftOAuthCodeResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/redeem-microsoft-oauth-code",
      body: "*"
    };
  }

  rpc IssueEmailVerificationChallenge(IssueEmailVerificationChallengeRequest) returns (IssueEmailVerificationChallengeResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/issue-email-verification-challenge",
      body: "*"
    };
  }

  rpc VerifyEmailChallenge(VerifyEmailChallengeRequest) returns (VerifyEmailChallengeResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/verify-email-challenge",
      body: "*"
    };
  }

  rpc RegisterPassword(RegisterPasswordRequest) returns (RegisterPasswordResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/register-password",
      body: "*"
    };
  }

  rpc VerifyPassword(VerifyPasswordRequest) returns (VerifyPasswordResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/verify-password",
      body: "*"
    };
  }

  rpc GetPasskeyOptions(GetPasskeyOptionsRequest) returns (GetPasskeyOptionsResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/get-passkey-options",
      body: "*"
    };
  }

  rpc RegisterPasskey(RegisterPasskeyRequest) returns (RegisterPasskeyResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/register-passkey",
      body: "*"
    };
  }

  rpc IssuePasskeyChallenge(IssuePasskeyChallengeRequest) returns (IssuePasskeyChallengeResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/issue-passkey-challenge",
      body: "*"
    };
  }

  rpc VerifyPasskey(VerifyPasskeyRequest) returns (VerifyPasskeyResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/verify-passkey",
      body: "*"
    };
  }

  rpc GetAuthenticatorAppOptions(GetAuthenticatorAppOptionsRequest) returns (GetAuthenticatorAppOptionsResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/get-authenticator-app-options",
      body: "*"
    };
  }

  rpc RegisterAuthenticatorApp(RegisterAuthenticatorAppRequest) returns (RegisterAuthenticatorAppResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/register-authenticator-app",
      body: "*"
    };
  }

  rpc VerifyAuthenticatorApp(VerifyAuthenticatorAppRequest) returns (VerifyAuthenticatorAppResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/verify-authenticator-app",
      body: "*"
    };
  }

  rpc SetEmailAsPrimaryLoginFactor(SetEmailAsPrimaryLoginFactorRequest) returns (SetEmailAsPrimaryLoginFactorResponse) {
    option (google.api.http) = {
      post: "/intermediate/v1/set-email-as-primary-login-factor",
      body: "*"
    };
  }

  rpc CreateProject(CreateProjectRequest) returns (CreateProjectResponse);
}

message IntermediateSession {
  string id = 1;
  string project_id = 2;
  string email = 3;
  bool email_verified = 4;
  string google_user_id = 5;
  string google_hosted_domain = 6;
  string microsoft_user_id = 7;
  string microsoft_tenant_id = 8;
  string organization_id = 9;
  bool password_verified = 10;
  bool new_user_password_registered = 11;
  bool email_verification_challenge_registered = 12;
  string primary_login_factor = 13;
}

message Settings {
  string id = 1;
  string project_id = 2;
  google.protobuf.Timestamp create_time = 3;
  google.protobuf.Timestamp update_time = 4;
  string logo_url = 5;
  string favicon_url = 6;
  string primary_color = 7;
  bool detect_dark_mode_enabled = 8;
  string dark_mode_logo_url = 9;
  string dark_mode_primary_color = 10;
  string log_in_layout = 11;
  bool log_in_with_email = 12;
  bool log_in_with_google = 13;
  bool log_in_with_microsoft = 14;
  bool log_in_with_password = 15;
  bool log_in_with_saml = 16;
}

message CreateProjectRequest {
  string display_name = 1;
}
message CreateProjectResponse {
  Project project = 1;
}

message CreateIntermediateSessionRequest {
}

message CreateIntermediateSessionResponse {
  string intermediate_session_secret_token = 1;
}

message WhoamiRequest {
}

message WhoamiResponse {
  IntermediateSession intermediate_session = 1;
}

message CreateOrganizationRequest {
  string display_name = 1;
}

message CreateOrganizationResponse {
  string organization_id = 1;
}

message SetOrganizationRequest {
  string organization_id = 1;
}

message SetOrganizationResponse {
}

message ExchangeIntermediateSessionForSessionRequest {
  string organization_id = 1;
}

message ExchangeIntermediateSessionForSessionResponse {
  string refresh_token = 1;
  string access_token = 2;
}

message GetGoogleOAuthRedirectURLRequest {
  string redirect_url = 1;
}

message GetGoogleOAuthRedirectURLResponse {
  string url = 1;
}

message RedeemGoogleOAuthCodeRequest {
  string code = 1;
  string state = 2;
  string redirect_url = 3;
}

message RedeemGoogleOAuthCodeResponse {
}

message GetMicrosoftOAuthRedirectURLRequest {
  string redirect_url = 1;
}

message GetMicrosoftOAuthRedirectURLResponse {
  string url = 1;
}

message RedeemMicrosoftOAuthCodeRequest {
  string code = 1;
  string state = 2;
  string redirect_url = 3;
}

message RedeemMicrosoftOAuthCodeResponse {
}

message Organization {
  string id = 1;
  string display_name = 2;
  bool log_in_with_email = 3;
  bool log_in_with_google = 4;
  bool log_in_with_microsoft = 5;
  bool log_in_with_password = 6;
  bool log_in_with_saml = 7;
  bool log_in_with_authenticator_app = 8;
  bool log_in_with_passkey = 9;
  bool require_mfa = 10;
  string primary_saml_connection_id = 11;
  bool user_exists = 12;
  bool user_has_password = 13;
  bool user_has_authenticator_app = 14;
  bool user_has_passkey = 15;
}

message Project {
  string id = 1;
  string organization_id = 2;
  google.protobuf.Timestamp create_time = 3;
  google.protobuf.Timestamp update_time = 4;
  string display_name = 5;
  optional string auth_domain = 6;
}

message IssueEmailVerificationChallengeRequest {
  string email = 1;
}

message IssueEmailVerificationChallengeResponse {}

message ListOrganizationsRequest {
}

message ListOrganizationsResponse {
  repeated Organization organizations = 1;
}

message ListSAMLOrganizationsRequest {
  string email = 1;
}

message ListSAMLOrganizationsResponse {
  repeated Organization organizations = 1;
}

message VerifyEmailChallengeRequest {
  string code = 2;
}

message VerifyEmailChallengeResponse {}

message RegisterPasswordRequest {
  string password = 1;
}

message RegisterPasswordResponse {
}

message VerifyPasswordRequest {
  string organization_id = 1;
  string password = 2;
}

message VerifyPasswordResponse {
}

message GetSettingsRequest {
}

message GetSettingsResponse {
  Settings settings = 1;
}

message RedeemUserImpersonationTokenRequest {
  string secret_user_impersonation_token = 1;
}

message RedeemUserImpersonationTokenResponse {
  string refresh_token = 1;
  string access_token = 2;
}

message GetAuthenticatorAppOptionsRequest {
}

message GetAuthenticatorAppOptionsResponse {
  string otpauth_uri = 1;
}

message RegisterAuthenticatorAppRequest {
  string totp_code = 1;
}

message RegisterAuthenticatorAppResponse {
  repeated string recovery_codes = 1;
}

message VerifyAuthenticatorAppRequest {
  string totp_code = 1;
  string recovery_code = 2;
}

message VerifyAuthenticatorAppResponse {
}

message GetPasskeyOptionsRequest {
}

message GetPasskeyOptionsResponse {
  string rp_name = 1;
  string user_id = 2;
  string user_display_name = 3;
}

message RegisterPasskeyRequest {
  string attestation_object = 1;
  string rp_id = 2;
}

message RegisterPasskeyResponse {
}

message IssuePasskeyChallengeRequest {
}

message IssuePasskeyChallengeResponse {
  repeated bytes credential_ids = 1;
  bytes challenge = 2;
}

message VerifyPasskeyRequest {
  bytes credential_id = 1;
  string client_data_json = 2;
  string authenticator_data = 3;
  string signature = 4;
}

message VerifyPasskeyResponse {
}

message SetEmailAsPrimaryLoginFactorRequest {
}

message SetEmailAsPrimaryLoginFactorResponse {
}
